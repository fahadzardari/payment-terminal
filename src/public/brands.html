<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brand Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
        padding-bottom: 50px;
      }
      .header {
        background-color: #1e3a8a;
        padding: 20px;
        color: white;
        margin-bottom: 30px;
      }
      .header h1 {
        margin: 0;
      }
      .card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }
      .card-header {
        background-color: #4361ee;
        color: white;
        font-weight: bold;
        border-radius: 10px 10px 0 0 !important;
      }
      .brand-logo-preview {
        max-height: 60px;
        max-width: 120px;
      }
      .edit-btn {
        background-color: #4361ee;
        border-color: #4361ee;
      }
      .add-brand-btn {
        background-color: #4361ee;
        border-color: #4361ee;
      }
      .logo-info {
        background-color: #e9f5fe;
        border-left: 4px solid #4361ee;
        padding: 15px;
        margin-bottom: 20px;
      }
      .alert {
        display: none;
        margin-top: 20px;
      }
      .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: #6c757d;
      }
      .table-responsive {
        overflow-x: auto;
      }
      .form-label {
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container">
        <a class="navbar-brand" href="/agent/payments"
          >Payment Terminal</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/agent/payments">Payments</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/agent/create-link">Create Payment</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/agent/brands">Brands</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/agent/contact-requests"
                >Contact Requests</a
              >
            </li>
          </ul>
          <div class="d-flex">
            <button onclick="logout()" class="btn btn-outline-light">
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- Alerts -->
      <div class="alert alert-success" id="success-alert" role="alert"></div>
      <div class="alert alert-danger" id="error-alert" role="alert"></div>

      <!-- Brands Table -->
      <div class="card">
        <div class="card-header">All Brands</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Logo</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="brands-table-body">
                <!-- Brands will be loaded here -->
              </tbody>
            </table>
          </div>
          <div id="empty-state" class="empty-state">
            <i class="bi bi-building" style="font-size: 3rem"></i>
            <h4 class="mt-3">No brands found</h4>
            <p>Add your first brand using the form below</p>
          </div>
        </div>
      </div>

      <!-- Add New Brand Card -->
      <div class="card">
        <div class="card-header">Add New Brand</div>
        <div class="card-body">
          <!-- Logo Info Box -->
          <div class="logo-info">
            <h5>
              <i class="bi bi-info-circle-fill me-2"></i> Logo Upload
              Instructions
            </h5>
            <p>For brand logos:</p>
            <ol>
              <li> 
                Upload logo in upload logo section below.
                 </li>
                 <li> 
                  The url will be automatically added no need to fill it manually
                 </li>
            </ol>
            
          </div>

          <form id="add-brand-form">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="name" class="form-label">Brand Name*</label>
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  name="name"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Brand Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  placeholder="info@example.com"
                />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Logo</label>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="logo-upload-section">
                    <div class="card p-3">
                      <h6><i class="bi bi-upload me-2"></i>Upload New Logo</h6>
                      <div class="mb-3">
                        <input
                          type="file"
                          class="form-control"
                          id="logo-file"
                          accept="image/png,image/jpeg,image/svg+xml,image/gif"
                        />
                      </div>
                      <div
                        id="logo-preview-container"
                        class="text-center mb-3"
                        style="display: none"
                      >
                        <img
                          id="logo-preview"
                          src=""
                          alt="Logo preview"
                          class="brand-logo-preview"
                        />
                        <button
                          type="button"
                          class="btn btn-sm btn-danger mt-2"
                          id="remove-logo"
                        >
                          <i class="bi bi-trash"></i> Remove
                        </button>
                      </div>
                      <button
                        type="button"
                        class="btn btn-outline-primary btn-sm"
                        id="upload-logo-btn"
                      >
                        <i class="bi bi-cloud-arrow-up"></i> Upload Logo
                      </button>
                      <div
                        class="progress mt-2"
                        style="display: none"
                        id="upload-progress-container"
                      >
                        <div
                          class="progress-bar progress-bar-striped progress-bar-animated"
                          role="progressbar"
                          style="width: 0%"
                          id="upload-progress"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="card p-3">
                    <h6>
                      <i class="bi bi-link-45deg me-2"></i>Or Enter Logo URL
                    </h6>
                    <label for="logoUrl" class="form-label">Logo URL</label>
                    <input
                      disabled
                      type="text"
                      class="form-control"
                      id="logoUrl"
                      name="logoUrl"
                      placeholder="/brand-logos/your-logo.svg"
                    />
                    <small class="text-muted">Path to existing logo file</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea
                class="form-control"
                id="description"
                name="description"
                rows="3"
              ></textarea>
            </div>
            <button type="submit" class="btn btn-primary add-brand-btn">
              Add Brand
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Brand Modal -->
    <div
      class="modal fade"
      id="editBrandModal"
      tabindex="-1"
      aria-labelledby="editBrandModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editBrandModalLabel">Edit Brand</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-brand-form">
              <input type="hidden" id="edit-id" />
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="edit-name" class="form-label">Brand Name*</label>
                  <input
                    type="text"
                    class="form-control"
                    id="edit-name"
                    name="name"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="edit-email" class="form-label">Brand Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="edit-email"
                    name="email"
                    placeholder="info@example.com"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Logo</label>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="logo-upload-section">
                      <div class="card p-3">
                        <h6>
                          <i class="bi bi-upload me-2"></i>Upload New Logo
                        </h6>
                        <div class="mb-3">
                          <input
                            type="file"
                            class="form-control"
                            id="edit-logo-file"
                            accept="image/png,image/jpeg,image/svg+xml,image/gif"
                          />
                        </div>
                        <button
                          type="button"
                          class="btn btn-outline-primary btn-sm"
                          id="edit-upload-logo-btn"
                        >
                          <i class="bi bi-cloud-arrow-up"></i> Upload Logo
                        </button>
                        <div
                          class="progress mt-2"
                          style="display: none"
                          id="edit-upload-progress-container"
                        >
                          <div
                            class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar"
                            style="width: 0%"
                            id="edit-upload-progress"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="card p-3">
                      <h6>
                        <i class="bi bi-link-45deg me-2"></i>Or Enter Logo URL
                      </h6>
                      <label for="edit-logoUrl" class="form-label"
                        >Logo URL</label
                      >
                      <input
                        disabled
                        type="text"
                        class="form-control"
                        id="edit-logoUrl"
                        name="logoUrl"
                        placeholder="/brand-logos/your-logo.svg"
                      />
                      <small class="text-muted"
                        >Path to existing logo file</small
                      >
                    </div>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="edit-description" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="edit-description"
                  name="description"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Logo Preview</label>
                <div>
                  <img
                    id="edit-logo-preview"
                    src=""
                    alt="Logo preview"
                    class="brand-logo-preview d-none"
                  />
                  <span id="edit-no-logo-message" class="text-muted"
                    >No logo available</span
                  >
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="save-brand-changes"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Auth helper functions
      function getToken() {
        return localStorage.getItem("token");
      }

      function checkAuth() {
        const token = getToken();
        if (!token) {
          window.location.href = "/login";
          return false;
        }
        return true;
      }

      // Replace all fetch calls with this helper
      async function fetchWithAuth(url, options = {}) {
        if (!checkAuth()) return;

        const token = getToken();

        const headers = {
          Authorization: `Bearer ${token}`,
          ...options.headers,
        };

        // Only add Content-Type: application/json if not a FormData upload
        if (!options.isFormData) {
          headers["Content-Type"] = "application/json";
        }

        return fetch(url, {
          ...options,
          headers,
        });
      }

      // Add logout functionality
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/login";
      }

      // Initialize variables
      let editModal;

      document.addEventListener("DOMContentLoaded", function () {
        // Check authentication first thing
        if (!checkAuth()) return;

        // Initialize Bootstrap modal
        editModal = new bootstrap.Modal(
          document.getElementById("editBrandModal")
        );

        // Load all brands
        loadBrands();

        // Setup event listeners
        document
          .getElementById("add-brand-form")
          .addEventListener("submit", addBrand);
        document
          .getElementById("save-brand-changes")
          .addEventListener("click", saveChanges);

        // Logo URL preview change handlers
        document
          .getElementById("edit-logoUrl")
          .addEventListener("input", updateLogoPreview);
      });

      // Load all brands from API
      async function loadBrands() {
        try {
          const response = await fetchWithAuth("/api/brands");
          const result = await response.json();

          if (result.success) {
            displayBrands(result.data);
          } else {
            showError("Failed to load brands");
          }
        } catch (error) {
          console.error("Error loading brands:", error);
          showError("An error occurred while loading brands");
        }
      }

      // Display brands in the table
      function displayBrands(brands) {
        const tableBody = document.getElementById("brands-table-body");
        const emptyState = document.getElementById("empty-state");

        // Clear existing content
        tableBody.innerHTML = "";

        if (brands.length === 0) {
          tableBody.style.display = "none";
          emptyState.style.display = "block";
          return;
        }

        tableBody.style.display = "";
        emptyState.style.display = "none";

        brands.forEach((brand) => {
          const row = document.createElement("tr");

          // Create logo cell with image or placeholder
          const logoCell = document.createElement("td");
          if (brand.logoUrl) {
            const img = document.createElement("img");
            img.src = brand.logoUrl;
            img.alt = `${brand.name} logo`;
            img.className = "brand-logo-preview";
            img.onerror = function () {
              this.onerror = null;
              this.src = "https://placehold.co/100x50?text=No+Logo";
            };
            logoCell.appendChild(img);
          } else {
            logoCell.textContent = "No logo";
          }

          // Truncate description if too long
          const description = brand.description
            ? brand.description.length > 50
              ? brand.description.substring(0, 50) + "..."
              : brand.description
            : "No description";

          row.innerHTML = `
          <td>${brand.id}</td>
          <td>${logoCell.innerHTML}</td>
          <td>${brand.name}</td>
          <td>${brand.email || "â€”"}</td>
          <td>${description}</td>
          <td>
            <button class="btn btn-sm btn-primary edit-btn" data-id="${
              brand.id
            }">
              <i class="bi bi-pencil-square"></i> Edit
            </button>
          </td>
        `;

          // Add event listener to edit button
          row
            .querySelector(".edit-btn")
            .addEventListener("click", () => openEditModal(brand));

          tableBody.appendChild(row);
        });
      }

      // Open edit modal with brand data
      function openEditModal(brand) {
        document.getElementById("edit-id").value = brand.id;
        document.getElementById("edit-name").value = brand.name || "";
        document.getElementById("edit-email").value = brand.email || "";
        document.getElementById("edit-logoUrl").value = brand.logoUrl || "";
        document.getElementById("edit-description").value =
          brand.description || "";

        // Update logo preview
        updateLogoPreview();

        // Show the modal
        editModal.show();
      }

      // Update logo preview in edit modal
      function updateLogoPreview() {
        const logoUrl = document.getElementById("edit-logoUrl").value;
        const logoPreview = document.getElementById("edit-logo-preview");
        const noLogoMessage = document.getElementById("edit-no-logo-message");

        if (logoUrl) {
          logoPreview.src = logoUrl;
          logoPreview.classList.remove("d-none");
          noLogoMessage.classList.add("d-none");

          // Handle image load error
          logoPreview.onerror = function () {
            this.onerror = null;
            this.src = "https://placehold.co/100x50?text=Invalid+URL";
          };
        } else {
          logoPreview.classList.add("d-none");
          noLogoMessage.classList.remove("d-none");
        }
      }

      // Add new brand
      async function addBrand(e) {
        e.preventDefault();

        const brandData = {
          name: document.getElementById("name").value,
          email: document.getElementById("email").value,
          logoUrl: document.getElementById("logoUrl").value,
          description: document.getElementById("description").value,
        };

        try {
          const response = await fetchWithAuth("/api/brands", {
            method: "POST",
            body: JSON.stringify(brandData),
          });

          const result = await response.json();

          if (result.success) {
            showSuccess("Brand added successfully");
            document.getElementById("add-brand-form").reset();
            loadBrands(); // Reload the brands table
          } else {
            showError(`Failed to add brand: ${result.message}`);
          }
        } catch (error) {
          console.error("Error adding brand:", error);
          showError("An error occurred while adding the brand");
        }
      }

      // Save changes to an existing brand
      async function saveChanges() {
        const brandId = document.getElementById("edit-id").value;

        const brandData = {
          name: document.getElementById("edit-name").value,
          email: document.getElementById("edit-email").value,
          logoUrl: document.getElementById("edit-logoUrl").value,
          description: document.getElementById("edit-description").value,
        };

        try {
          const response = await fetchWithAuth(`/api/brands/${brandId}`, {
            method: "PUT",
            body: JSON.stringify(brandData),
          });

          const result = await response.json();

          if (result.success) {
            showSuccess("Brand updated successfully");
            editModal.hide();
            loadBrands(); // Reload the brands table
          } else {
            showError(`Failed to update brand: ${result.message}`);
          }
        } catch (error) {
          console.error("Error updating brand:", error);
          showError("An error occurred while updating the brand");
        }
      }

      // Show success message
      function showSuccess(message) {
        const alert = document.getElementById("success-alert");
        alert.textContent = message;
        alert.style.display = "block";

        setTimeout(() => {
          alert.style.display = "none";
        }, 3000);
      }

      // Show error message
      function showError(message) {
        const alert = document.getElementById("error-alert");
        alert.textContent = message;
        alert.style.display = "block";

        setTimeout(() => {
          alert.style.display = "none";
        }, 5000);
      }

      // Add these JavaScript functions to handle file upload

      // File upload preview
      document
        .getElementById("logo-file")
        .addEventListener("change", function () {
          const file = this.files[0];
          const previewContainer = document.getElementById(
            "logo-preview-container"
          );
          const previewImg = document.getElementById("logo-preview");

          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              previewImg.src = e.target.result;
              previewContainer.style.display = "block";
            };
            reader.readAsDataURL(file);
          }
        });

      // Remove logo preview
      document
        .getElementById("remove-logo")
        .addEventListener("click", function () {
          document.getElementById("logo-file").value = "";
          document.getElementById("logo-preview-container").style.display =
            "none";
        });

      // Upload logo button handler
      document
        .getElementById("upload-logo-btn")
        .addEventListener("click", async function () {
          const fileInput = document.getElementById("logo-file");
          const progressContainer = document.getElementById(
            "upload-progress-container"
          );
          const progressBar = document.getElementById("upload-progress");

          if (!fileInput.files.length) {
            showError("Please select a file to upload");
            return;
          }

          const file = fileInput.files[0];
          const formData = new FormData();
          formData.append("logo", file);
          formData.append(
            "name",
            document.getElementById("name").value || "brand"
          );

          try {
            // Show progress bar
            progressContainer.style.display = "block";
            progressBar.style.width = "0%";

            // Simulate progress (in a real implementation, you'd use XHR with progress events)
            const interval = setInterval(() => {
              const currentWidth = parseInt(progressBar.style.width, 10);
              if (currentWidth < 90) {
                progressBar.style.width = currentWidth + 10 + "%";
              }
            }, 200);

            // Upload file
            const response = await fetch("/api/brands/upload-logo", {
              method: "POST",
             
              body: formData,
            });

            clearInterval(interval); // Stop progress simulation
            progressBar.style.width = "100%";

            if (response.ok) {
              try {
                const result = await response.json();

                if (result.success) {
                  document.getElementById("logoUrl").value =
                    result.data.logoUrl;
                  showSuccess("Logo uploaded successfully");

                  // Hide progress after a delay
                  setTimeout(() => {
                    progressContainer.style.display = "none";
                  }, 1000);
                } else {
                  progressContainer.style.display = "none";
                  showError(`Upload failed: ${result.message}`);
                }
              } catch (error) {
                progressContainer.style.display = "none";
                showError("Invalid response from server");
              }
            } else {
              progressContainer.style.display = "none";
              showError(
                `Server error: ${response.status} ${response.statusText}`
              );
            }
          } catch (error) {
            progressContainer.style.display = "none";
            console.error("Error uploading logo:", error);
            showError("Error uploading logo. Please try again.");
          }
        });

      // Also add similar functionality for the edit form
      document
        .getElementById("edit-upload-logo-btn")
        .addEventListener("click", async function () {
          const fileInput = document.getElementById("edit-logo-file");
          const progressContainer = document.getElementById(
            "edit-upload-progress-container"
          );
          const progressBar = document.getElementById("edit-upload-progress");

          if (!fileInput.files.length) {
            showError("Please select a file to upload");
            return;
          }

          const file = fileInput.files[0];
          const formData = new FormData();
          formData.append("logo", file);
          formData.append(
            "name",
            document.getElementById("edit-name").value || "brand"
          );

          try {
            // Show progress
            progressContainer.style.display = "block";
            progressBar.style.width = "0%";

            // Simulate progress
            const interval = setInterval(() => {
              const currentWidth = parseInt(progressBar.style.width, 10);
              if (currentWidth < 90) {
                progressBar.style.width = currentWidth + 10 + "%";
              }
            }, 200);

            // Upload file
            const response = await fetch("/api/brands/upload-logo", {
              method: "POST",
              body: formData,
            });

            clearInterval(interval);
            progressBar.style.width = "100%";

            if (response.ok) {
              try {
                const result = await response.json();

                if (result.success) {
                  document.getElementById("edit-logoUrl").value =
                    result.data.logoUrl;
                  updateLogoPreview(); // Update the logo preview in the edit form
                  showSuccess("Logo uploaded successfully");

                  setTimeout(() => {
                    progressContainer.style.display = "none";
                  }, 1000);
                } else {
                  progressContainer.style.display = "none";
                  showError(`Upload failed: ${result.message}`);
                }
              } catch (error) {
                progressContainer.style.display = "none";
                showError("Invalid response from server");
              }
            } else {
              progressContainer.style.display = "none";
              showError(
                `Server error: ${response.status} ${response.statusText}`
              );
            }
          } catch (error) {
            progressContainer.style.display = "none";
            console.error("Error uploading logo:", error);
            showError("Error uploading logo. Please try again.");
          }
        });
    </script>
  </body>
</html>
