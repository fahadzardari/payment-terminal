<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Payment Link - Agent Portal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .form-container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }
      .form-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
      }
      .btn-create {
        background-color: #0070ba;
        border-color: #0070ba;
      }
      .btn-create:hover {
        background-color: #005ea6;
        border-color: #005ea6;
      }
      .result-container {
        margin-top: 30px;
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #f8f9fa;
        display: none;
      }
      .copy-btn {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container">
        <a class="navbar-brand" href="/agent/payments"
          >Payment Terminal</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/agent/payments">Payments</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/agent/create-link"
                >Create Payment</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/agent/brands">Brands</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/agent/contact-requests"
                >Contact Requests</a
              >
            </li>
          </ul>
          <div class="d-flex">
            <button onclick="logout()" class="btn btn-outline-light">
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="form-container">
        <div class="form-header">
          <h2>Create Payment Link</h2>
          <p class="text-muted">
            Generate a unique payment link for your customer
          </p>
        </div>

        <form id="payment-form">
          <div class="row mb-4">
            <div class="col-md-12">
              <h5>Customer Information</h5>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label for="customerName" class="form-label"
                >Customer Name*</label
              >
              <input
                type="text"
                class="form-control"
                id="customerName"
                required
              />
            </div>
            <div class="col-md-4">
              <label for="customerEmail" class="form-label"
                >Customer Email*</label
              >
              <input
                type="email"
                class="form-control"
                id="customerEmail"
                required
              />
            </div>
            <div class="col-md-4">
              <label for="customerPhone" class="form-label"
                >Customer Phone</label
              >
              <input type="tel" class="form-control" id="customerPhone" />
            </div>
          </div>

          <div class="row mb-4 mt-4">
            <div class="col-md-12">
              <h5>Service Information</h5>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="brandId" class="form-label">Brand*</label>
              <select class="form-select" id="brandId" required>
                <option value="">Select a brand</option>
                <!-- Brands will be loaded dynamically -->
              </select>
            </div>
            <div class="col-md-6">
              <label for="serviceName" class="form-label">Service Name*</label>
              <input
                type="text"
                class="form-control"
                id="serviceName"
                required
              />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label for="serviceDescription" class="form-label"
                >Service Description*</label
              >
              <textarea
                class="form-control"
                id="serviceDescription"
                rows="3"
                required
              ></textarea>
            </div>
          </div>

          <div class="row mb-4 mt-4">
            <div class="col-md-12">
              <h5>Payment Information</h5>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="amount" class="form-label">Amount*</label>
              <input
                type="number"
                step="0.01"
                min="0.01"
                class="form-control"
                id="amount"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="currency" class="form-label">Currency</label>
              <select class="form-select" id="currency">
                <option value="USD">USD - US Dollar</option>
                <option value="EUR">EUR - Euro</option>
                <option value="GBP">GBP - British Pound</option>
                <option value="CAD">CAD - Canadian Dollar</option>
                <option value="AUD">AUD - Australian Dollar</option>
              </select>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-12 text-center">
              <button type="submit" class="btn btn-primary btn-create btn-lg">
                Generate Payment Link
              </button>
            </div>
          </div>
        </form>

        <div class="result-container" id="result-container">
          <h5>Payment Link Generated!</h5>
          <div class="mb-3">
            <label class="form-label">Reference ID:</label>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="referenceId"
                readonly
              />
              <button
                class="btn btn-outline-secondary copy-btn"
                type="button"
                data-copy="referenceId"
              >
                Copy
              </button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Payment URL:</label>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="paymentUrl"
                readonly
              />
              <button
                class="btn btn-outline-secondary copy-btn"
                type="button"
                data-copy="paymentUrl"
              >
                Copy
              </button>
            </div>
          </div>
          <div class="text-center mt-4">
            <a id="open-link" href="#" target="_blank" class="btn btn-success"
              >Open Payment Page</a
            >
            <button id="create-new" class="btn btn-outline-primary ms-2">
              Create New Link
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Auth helper functions
      function getToken() {
        return localStorage.getItem("token");
      }

      function checkAuth() {
        const token = getToken();
        if (!token) {
          window.location.href = "/login";
          return false;
        }
        return true;
      }

      // Replace all fetch calls with this helper
      async function fetchWithAuth(url, options = {}) {
        if (!checkAuth()) return;

        const token = getToken();

        const headers = {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
          ...options.headers,
        };

        return fetch(url, {
          ...options,
          headers,
        });
      }

      // Add logout functionality
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/login";
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Check authentication first
        if (!checkAuth()) return;

        // Load brands when page loads
        loadBrands();

        // Form submission
        document
          .getElementById("payment-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            createPaymentLink();
          });

        // New link button
        document
          .getElementById("create-new")
          .addEventListener("click", function () {
            document.getElementById("payment-form").reset();
            document.getElementById("result-container").style.display = "none";
          });

        // Copy buttons
        document.querySelectorAll("[data-copy]").forEach((button) => {
          button.addEventListener("click", function () {
            const fieldId = this.getAttribute("data-copy");
            const field = document.getElementById(fieldId);
            field.select();
            document.execCommand("copy");

            // Change button text temporarily
            const originalText = this.textContent;
            this.textContent = "Copied!";
            setTimeout(() => {
              this.textContent = originalText;
            }, 1500);
          });
        });
      });

      // Load brands from API
      async function loadBrands() {
        try {
          const response = await fetchWithAuth("/api/brands");
          if (!response.ok) {
            throw new Error("Failed to load brands");
          }

          const { data } = await response.json();
          const brandSelect = document.getElementById("brandId");

          data.forEach((brand) => {
            const option = document.createElement("option");
            option.value = brand.id;
            option.textContent = brand.name;
            brandSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading brands:", error);
          alert("Failed to load brands. Please refresh the page.");
        }
      }

      // Create payment link
      async function createPaymentLink() {
        try {
          const payload = {
            customerName: document.getElementById("customerName").value,
            customerEmail: document.getElementById("customerEmail").value,
            customerPhone: document.getElementById("customerPhone").value,
            brandId: document.getElementById("brandId").value,
            serviceName: document.getElementById("serviceName").value,
            serviceDescription:
              document.getElementById("serviceDescription").value,
            amount: parseFloat(document.getElementById("amount").value),
            currency: document.getElementById("currency").value,
          };

          // Show loading indicator or disable submit button
          const submitButton = document.querySelector(".btn-create");
          const originalText = submitButton.textContent;
          submitButton.textContent = "Creating...";
          submitButton.disabled = true;

          const response = await fetchWithAuth("/api/payments/links", {
            method: "POST",
            body: JSON.stringify(payload),
          });

          // Re-enable button
          submitButton.textContent = originalText;
          submitButton.disabled = false;

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "Failed to create payment link");
          }

          // Display results only if successful
          document.getElementById("referenceId").value =
            result.data.referenceId;
          document.getElementById("paymentUrl").value = result.data.paymentUrl;
          document.getElementById("open-link").href = result.data.paymentUrl;
          document.getElementById("result-container").style.display = "block";

          // Scroll to results
          document
            .getElementById("result-container")
            .scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          console.error("Error creating payment link:", error);
          alert(`Failed to create payment link: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
